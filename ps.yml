app: PrusaSlicer
binpatch: true

ingredients:
  dist: buster
  script:
    - [ -d "PrusaSlicer-build" ] || git clone https://github.com/prusa3d/PrusaSlicer --single-branch --branch VERSION_PLACEHOLDER --depth 1 PrusaSlicer-build
    - cd PrusaSlicer-build && cd deps && mkdir -p build && cd build && CPWD=$(readlink -f .) && cmake -G Ninja .. && ninja && cd ../.. && mkdir -p build && cd build && cmake .. -G Ninja -DCMAKE_PREFIX_PATH="${CPWD}/destdir/usr/local" -DSLIC3R_STATIC=1 -DCMAKE_INSTALL_PREFIX=/usr && ninja && rm -f resources && ln -sr ../resources resources 
script:
  - cp ../PrusaSlicer-build/resources/icons/PrusaSlicer.png PrusaSlicer.png
  # Workaround when using PrusaSlicer on X-over-SSH (and compiled with GTK3). Basic theme and icon sets.
  - mkdir -p ./usr/share/mime/packages && cp -a /usr/share/mime/packages/freedesktop.org.xml ./usr/share/mime/packages/
  - update-mime-database ./usr/share/mime
  - mkdir -p ./usr/share/icons/Adwaita/ && cp -a /usr/share/icons/Adwaita/* ./usr/share/icons/Adwaita/
  - mkdir -p ./usr/share/glib-2.0/schemas && cp -a /usr/share/glib-2.0/schemas/* ./usr/share/glib-2.0/schemas
  - pwd
  - mkdir -p ./usr/resources && cp -a ../PrusaSlicer-build/resources/* ./usr/resources/
  - cp ../PrusaSlicer-build/resources/icons/PrusaSlicer.png ./usr/resources/icons/prusaslicer.png
  - mkdir -p ./usr/bin/ && cp -R ../PrusaSlicer-build/build/src/prusa-slicer ./usr/bin/
  - cat > ./PrusaSlicer.desktop <<EOF
  - [Desktop Entry]
  - Name=PrusaSlicer
  - Exec=prusa-slicer
  - Icon=PrusaSlicer
  - Terminal=false
  - Type=Application
  - Categories=Graphics;3DGraphics;
  - EOF
